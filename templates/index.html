{% extends 'base.html' %}
{% block content %}
    <h2>Capturar datos</h2>
    <div class="row">
        <form method="post" action="/add_plaza">
            <h3>Nueva caseta</h3>
            <label>Nombre</label>
            <input name="name" required placeholder="Ej. Caseta Queretaro"/>
            <label>Carretera / Tramo</label>
            <input name="road" placeholder="MEX 57"/>
            <label>Estado</label>
            <input name="state" placeholder="Guanajuato"/>
            <label>Km</label>
            <input name="km_marker" placeholder="km 37"/>
            <label>Operador</label>
            <input name="operator" placeholder="CAPUFE"/>
            <label>Código (opcional)</label>
            <input name="code" placeholder="ID interno"/>
            <br><br>
            <button class="btn" type="submit">Guardar caseta</button>
        </form>

        <form method="post" action="/add_price">
            <h3>Nuevo precio</h3>
            <label>Caseta</label>
            <select name="toll_plaza_id" required>
                <option value="">— Selecciona —</option>
                {% for p in plazas %}
                <option value="{{p.id}}">{{p.name}}</option>
                {% endfor %}
            </select>
            <label>Clase de vehículo</label>
            <input name="vehicle_class" placeholder="AUTO / BUS / CAMION_2E"/>
            <label>Precio (MXN)</label>
            <input name="price" type="number" step="0.01" min="0" required />
            <label>Fecha del precio</label>
            <input name="collected_at" type="date" required />
            <br><br>
            <button class="btn" type="submit">Guardar / Actualizar</button>
        </form>
    </div>

    <hr style="margin:20px 0; border-color:#1f2937">

    <h3>Catálogo de casetas</h3>
    <p class="tiny muted">Puedes borrar casetas individuales o depurar las que no tienen precios.</p>

    <form method="post" action="/admin/delete_empty_plazas"
        onsubmit="return confirm('¿Borrar TODAS las casetas sin precios?');">
    <button class="btn" type="submit">Eliminar casetas sin precios</button>
    </form>

    <!-- (Opcional MUY peligroso) -->
    <form method="post" action="/admin/delete_all_plazas"
        onsubmit="return confirm('⚠️ Esto borra TODAS las casetas y precios. ¿Continuar?');"
        style="margin-top:10px">
    <button class="btn" type="submit" style="background:#ef4444;color:#fff">Eliminar TODAS las casetas</button>
    </form>

    <table style="margin-top:16px">
    <thead>
        <tr>
        <th>ID</th>
        <th>Caseta</th>
        <th>Carretera</th>
        <th>Estado</th>
        <th>Precios vinculados</th>
        <th></th>
        </tr>
    </thead>
    <tbody>
        {% for p in plazas %}
        <tr>
            <td>{{ p.id }}</td>
            <td>{{ p.name }}</td>
            <td>{{ p.road or '—' }}</td>
            <td>{{ p.state or '—' }}</td>
            <td>{{ p.prices|length }}</td>
            <td>
                <form method="post" action="/admin/delete_plaza/{{ p.id }}" data-pname="{{ p.name|e }}" onsubmit="return confirm('¿Eliminar ' + this.dataset.pname + '? Se borrarán también sus precios.');">
                    <button class="btn" type="submit" style="background:#ef4444;color:#fff">Borrar</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
    </table>

    <style>
        .tiny { font-size:12px; opacity:.8 }
        .muted { color:#9ca3af }
    </style>

{% endblock %}